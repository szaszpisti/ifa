<?
if (defined("user.class")) return;
define("user.class", "1");

include("fogado.inc");

class User {

/* változók:
valid:  ezzel az azonosítóval be lehet-e jelentkezni ebben az idõben?
good:   ha a jelszó egyezik
probed: volt már próbálkozás
admin:  admin-e
id:     kívánt azonosító

függvények
user_init(id):  az id-hez tartozó db-rekordot beolvassa tulajdonságokba
kilep():        session lezárás
loginUrlap():   a megfelelõ bejelentkezési ürlap -- vagy: nem elérhetõ
*/

	function User() {
		global $FA;
		if (isset($_REQUEST['kilep'])) { $this->kilep(); }
		$this->good = false;
		$this->probed = false;

		# Ha kaptunk az URL-ben id-et:
		session_start();
		$this->admin = $_SESSION['admin'];
		if (isset($_REQUEST['id'])) {

			# Elõször az id alapján beállítjuk, ha minden jól megy, ez lesz a juzer.
			$this->user_init($_REQUEST['id']);

			# Aztán megnézzük, hogy lehet-e rögzíteni?  Ha admin, akkor igen.
			if ($this->admin) {
				$_SESSION['id'] = $_REQUEST['id'];
				$this->good = true;
			}

			# Ha eddig is ez volt az érvényes user, akkor jó.
			elseif ($_SESSION['id'] == $_REQUEST['id']) {
				$this->good = true;
			}

			# Különben jelszavazni kell, megnézzük, van-e
			elseif (isset($_REQUEST["jelszo"])) {

				# Ha jó a jelszó, regisztráljuk
				if (md5($_REQUEST['jelszo']) === $this->jelszo) {
					if ($this->id === "0") {
						$_SESSION['admin'] = true;
						$this->admin = true;
					}
					$_SESSION['id'] = $this->id;
					$this->good = true;
					Ulog ($this->id, "Sikeres bejelentkezés");
				} else {
					Ulog ($this->id, "ROSSZ jelszó");
				}
				$this->probed = true;
			}

			$this->valid = ( ($FA->valid) || ($this->admin) || ($this->id === "0") );
			if (!$this->valid || !$this->good) {
				$this->loginUrlap();
				exit();
			}
		session_write_close();
		}

		# Ha nincs az URL-ben id, de legalább a session-ben van:
		elseif (isset($_SESSION['id'])) {
			$this->user_init($_SESSION['id']);
		}

		# Ha meg semmise nincsen (pl. normál kijelentkezés után)
		else {
			@readfile("leiras.html");
			exit();
		}
	}

	# Az azonosítóhoz tartozó adatbázis bejegyzés beolvasása, mezõnként egy változó
	function user_init($uid) {
		if ($res = pg_query("SELECT * FROM Diak WHERE id=" . $uid) and pg_num_rows($res)==1) {
			$u = pg_fetch_assoc($res);
			while(list($k, $v) = each($u)) $this->$k = $v;
		}
	}

	function kilep() {
		session_start();
		session_destroy();
		header('Location: ' . $_SERVER['PHP_SELF']);
	}

	function loginUrlap() {
		global $FA;
		Head('Fogatóóra bejelentkezés');
		if (!$this->valid) {
			print "<h3>Nincs bejelentkezési idõszak!</h3>\n";
			print "<b>" . substr($FA->valid_kezd, 0, -3) . "</b> &nbsp; és &nbsp; <b>" . substr($FA->valid_veg, 0, -3) . "</b> &nbsp; között lehet bejelentkezni.\n";
			Tail();
			exit;
		}

		else {
			print "\n<table width=100%><tr><td>\n<h3>" . $this->dnev . " " . $this->onev . "</h3>\n"
				. "<td align=right valign=top><a href=leiras.html> Leírás </a>\n</table>\n"
				. (($this->probed) ? "Rossz jelszót adtál!<br>\n" : "")
				. "<script language=JavaScript><!--\n"
				. "    document.login.jelszo.focus();\n"
				. "//--></script>\n"
				. "<form name=login action='" . $_SERVER['PHP_SELF'] . "' method=post>\n"
				. "  Jelszó: <input type=password size=8 name=jelszo>\n"
				. "  <input type=hidden name=id value=" . $this->id . ">\n"
				. "  <input type=submit value='Belépés'>\n"
				. "</form>\n\n";
			Tail();
		}
	}
}

?>
